#!/bin/bash

set -e

# Retrieve arguments
domain=$1
name=$2
repository=$3
restart=$4
command=$5

# Check ports availability
#sudo yunohost app checkport 9000
#if [[ ! $? -eq 0 ]]; then
#  exit 1
#fi

sudo yunohost app setting dockercontainer name -v $name

# Install Docker if it is not installed yet
if [ -f /usr/bin/docker ]; then
	echo "Docker is already installed"
else
	echo "Docker will now be installed"
	sudo apt-get install curl -y -qq
	sudo curl -sSL https://get.docker.com/ | sh
	sudo yunohost service add docker
	sudo update-rc.d docker defaults
	sudo service docker start 
	sudo usermod -aG docker admin
	newgrp docker
fi
sudo service docker restart

# Create Docker container
if [ "$restart" = "Yes" ];
then
	command+=" --restart always"
fi

sudo docker run -d $command --name=$name $repository

# Manage container as daemon with init
#sed -i "s@CONTAINERNAME$name@g" ../conf/init.d
#sudo cp ../conf/init.d /etc/init.d/container-$name
#sudo chmod 0755 /etc/init.d/container-$name
#sudo yunohost service add container-$name

# Manage container as daemon with systemd
sudo sed -i "s@CONTAINERNAME@$name@g" ../conf/systemd.service
sudo cp ../conf/systemd.service /etc/systemd/system/multi-user.target.wants/container-$name.service
sudo chmod 644 /etc/systemd/system/multi-user.target.wants/container-$name.service
sudo yunohost service add container-$name

sudo service nginx reload
sudo yunohost app ssowatconf